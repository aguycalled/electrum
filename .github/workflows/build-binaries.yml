name: Build Binaries

on:
  push:
    branches:
      - master
    tags:
      - '*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Windows binaries
        run: |
          ELECBUILD_COMMIT=HEAD ./contrib/build-wine/build.sh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: contrib/build-wine/dist/*.exe
          if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux AppImage
        run: |
          ELECBUILD_COMMIT=HEAD ./contrib/build-linux/appimage/build.sh

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: dist/*.AppImage
          if-no-files-found: error

  build-macos:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install Homebrew dependencies
        run: |
          brew update
          brew install automake autoconf libtool gettext coreutils pkgconfig libusb qt@5

      - name: Set up Python via pyenv
        run: |
          # Install pyenv
          brew install pyenv
          
          # Initialize pyenv in this shell
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          
          # Install Python 3.9.4
          PYTHON_CONFIGURE_OPTS="--enable-framework" pyenv install -s 3.9.4
          pyenv global 3.9.4
          
          # Verify installation
          python3 --version

      - name: Build macOS binaries
        run: |
          # Set up pyenv
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          
          # Set up Qt5
          export PATH="$(brew --prefix qt@5)/bin:$PATH"
          export PKG_CONFIG_PATH="$(brew --prefix qt@5)/lib/pkgconfig:$PKG_CONFIG_PATH"
          
          # Run build
          ./contrib/osx/make_osx

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: dist/*.dmg
          if-no-files-found: error

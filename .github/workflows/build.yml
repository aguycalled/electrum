name: Build Binaries

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  ELECTRUM_PACKAGE: NavCash

jobs:
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Build AppImage
        run: |
          # Fix for CI environment (no sudo needed, use docker directly)
          cd contrib/build-linux/appimage
          
          # Build Docker image
          docker build \
            --platform linux/amd64 \
            -t electrum-appimage-builder-img \
            .
          
          # Run build
          docker run \
            --platform linux/amd64 \
            --name electrum-appimage-builder-cont \
            -v "$GITHUB_WORKSPACE":/opt/electrum \
            --rm \
            --workdir /opt/electrum/contrib/build-linux/appimage \
            electrum-appimage-builder-img \
            ./make_appimage.sh

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: dist/*.AppImage
          if-no-files-found: error

  build-windows:
    name: Build Windows Executable
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Build Windows Executable
        run: |
          cd contrib/build-wine
          
          # Build Docker image
          docker build \
            --platform linux/amd64 \
            -t electrum-wine-builder-img \
            .
          
          # Run build
          docker run \
            --platform linux/amd64 \
            --name electrum-wine-builder-cont \
            -v "$GITHUB_WORKSPACE":/opt/wine64/drive_c/electrum \
            --rm \
            --workdir /opt/wine64/drive_c/electrum/contrib/build-wine \
            electrum-wine-builder-img \
            ./make_win.sh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          path: contrib/build-wine/dist/*.exe
          if-no-files-found: error

  build-macos:
    name: Build macOS DMG
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install automake autoconf libtool gettext coreutils pkgconfig

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Build macOS App
        run: |
          # Install build requirements
          python3 -m pip install --upgrade pip
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements-build-mac.txt
          
          # Build libsecp256k1
          ./contrib/make_libsecp256k1.sh
          
          # Install requirements
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements.txt || true
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements-hw.txt || true
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements-binaries-mac.txt || true
          
          # Install the package
          python3 -m pip install --no-dependencies .
          
          # Get version
          VERSION=$(git describe --tags --dirty --always)
          
          # Build with PyInstaller
          pyinstaller --noconfirm --ascii --clean --name "$VERSION" contrib/osx/osx.spec
          
          # Create DMG
          hdiutil create -fs HFS+ -volname "$ELECTRUM_PACKAGE" -srcfolder "dist/$ELECTRUM_PACKAGE.app" "dist/$ELECTRUM_PACKAGE-$VERSION.dmg"

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg
          if-no-files-found: error

  build-macos-arm64:
    name: Build macOS DMG (Apple Silicon)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install automake autoconf libtool gettext coreutils pkgconfig

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Build macOS App (ARM64)
        run: |
          # Install build requirements
          python3 -m pip install --upgrade pip
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements-build-mac.txt
          
          # Build libsecp256k1
          ./contrib/make_libsecp256k1.sh
          
          # Install requirements
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements.txt || true
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements-hw.txt || true
          python3 -m pip install --no-dependencies -r ./contrib/deterministic-build/requirements-binaries-mac.txt || true
          
          # Install the package
          python3 -m pip install --no-dependencies .
          
          # Get version
          VERSION=$(git describe --tags --dirty --always)
          
          # Build with PyInstaller
          pyinstaller --noconfirm --ascii --clean --name "$VERSION" contrib/osx/osx.spec
          
          # Create DMG
          hdiutil create -fs HFS+ -volname "$ELECTRUM_PACKAGE" -srcfolder "dist/$ELECTRUM_PACKAGE.app" "dist/$ELECTRUM_PACKAGE-$VERSION-arm64.dmg"

      - name: Upload macOS ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-arm64
          path: dist/*.dmg
          if-no-files-found: error

  create-release:
    name: Create Release (tags only)
    needs: [build-linux, build-windows, build-macos, build-macos-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/**/*

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.exe
            artifacts/**/*.dmg
          draft: true
          generate_release_notes: true

